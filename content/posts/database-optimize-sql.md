---
title: "Database：高性能 MySQL - 优化查询"
author: "Chenghao Zheng"
tags: ["Database"]
categories: ["Reading notes"]
date: 2020-12-22T13:29:47+01:00
draft: false
---

一个 MySQL 的查询任务，可以看作是一系列子任务，每个子任务都会消耗一定的时间，包括：网络、CPU 计算、生成统计信息和执行计划、锁等待等。如果要优化查询，实际上要优化其子任务，消除其中的一些子任务，减少子任务的执行次数，让子任务运行得更快。因此，了解 **查询的生命周期**、清楚查询的时间消耗情况对于优化查询有很大的意义。

在 [Database：高性能 MySQL - 索引](https://nervousorange.github.io/2020/database-index/) 篇笔者已经讲述了索引对良好的性能有着重要的影响，但如果查询写的很糟糕，即使库表结果再合理、索引再合适，也无法实现高性能。本篇将结合 [《高性能 MySQL》](https://book.douban.com/subject/23008813/) 第六章 查询性能优化 的内容讲解 MySQL 如何真正地执行查询，查询高效和低效的原因何在，以及该如何合理的设计查询。


# 查询执行的基础

### MySQL 客户端/服务器通信协议

一般来说不需要去理解 MySQL 通信协议的内部实现细节，只需要大致理解通信协议是如何工作的。MySQL 客户端和服务器之间的通信协议是 "**半双工**" 的，这意味着在任何一个时刻，要么是由服务器向客户端发送数据，要么是由客户端向服务器发送数据，这两个动作不能同时发生，无法也无须将一个消息切成小块独立来发送。

这种协议让 MySQL **通信简单快速**，但也给了 MySQL 一些限制，比如：

* 无法进行 **流量控制**，服务器必须接收客户端传来的完整查询消息才能响应，当查询语句过长超过 `max_allowed_packet` 时，服务器会拒绝接收并抛出错误。

* 客户端必须完整地接收整个返回结果，而不能简单地只取前面几条结果，然后让服务器停止发送数据。这也是在必要的时候一定要在查询中加上 `limit` 限制的原因。

* MySQL 通常需要等所有数据都发送给客户端后才能释放这条查询所占用的资源，如果查询返回了一个很大的结果集，库函数会花很多时间和内存来存储所有的结果集，给服务器造成一定的压力。

### 查询执行流程

想要清楚 MySQL 

![](/images/mysql_execution.jpg)

### 查询优化处理

# 慢查询基础：优化数据访问

### 是否扫描了额外的记录

### 一个复杂查询还是多个简单查询

# 优化特定类型的查询

### 优化 count() 查询

### 优化关联查询

### 优化子查询

### 优化 group by 和 distinct

### 优化 limit 分页

